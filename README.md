# NBT Bridge project

Retrofitting of NBT media system from BMW F series provides a lot of cool features for a better user experience, such as Bluetooth handsfree, GPS navigation, video player, and a lot more. All of these are supplied with a huge 8.8" inches screen and best in the class iDrive controller, that also supports touch actions. However, this does not work as plug and play, matching E and F series data transfer protocol is needed.

![alt text](https://github.com/vchmykhun-collab/NBT-bridge/blob/master/assets/bench.png?raw=true)

## Objectives, Challenges

Communication between the head unit and BMW E and F series was established by different versions of the CAN protocol. E-series works with low-speed 100Kbps bus, but F-series received K-CAN 2 with 500Kbps, which also operates using another message IDs, that rarely match with K-CAN 1 version.

The radio panel is not connected to a head unit directly, and the function of processing buttons and dimming lights is controlled by the FEM module, which does not exist at the e-series. Communication is established at LIN protocol, where the front panel works as a slave module and FEM as a master.

![alt text](https://github.com/vchmykhun-collab/NBT-bridge/blob/master/assets/Diagram.png?raw=true)


## Successful functions

* Setup date and time
* Info: fuel consumption, avg speed, reset both params
* Displaying Diag information
* Reset tire pressure
* Dimming lights
* PDC sound confirmation
* Video in motion

## Known Issues, Limitations

* Parking system just beeps, there is no animation on a screen
* Fuel consumption statistics does not work
* Screen brightness is not adjusted automatically

## CAN message explained

The controller wakes up when power supply 30A is restored. BMW turns off the 30A connection after 15 minutes idle.
So, once the car is unlocked controller wakes up NBT using the `0x12f` message.

Every second it sends regional format and language adjustments as a `0x2f7` message. Then every 100ms it confirms to NBT `0x12f` that it should remain active `0x510`, and also halts current speed `0x1a1` for allowing video in motion.

All other time controller is busy transferring messages between head unit and vehicle.

### Forward to NBT

| Arbid | Comments |
| --- | --- |
| 0x202 | Dimming lights | 
| 0x380 | VIN, should not be forwarded | 
| 0x130 | Ignition status, require protocol matching to 0x12f message |
| 0x2f7 | lang and formats, do not forward, conotroller will setup it's own |
| 0x1a1 | vehicle speed, do not forward, required for video in motion |


### Forward from NBT

There is a lot of traffic generated by the iDrive controller, nothing of it is required for BMW, or unless gesture recognition is needed to develop separately.

| Arbid | Comments |
| --- | --- |
| 0x2b8 | actions for trip statistics: reset avg speed, milage, etc |
| 0x398 | reset tire pressure |
| 0x39e | set date/time |
| 0x291 | set locale, format |
| 0x3dc, 0xf0, 0x45b | light setup |
| 0x45b | brightness setup |
| 0x3d4 | autolock setup |
| 0x421 | eco mode settings |
| 0x2a4 | profiles selection | 

## Front panel

![alt text](https://github.com/vchmykhun-collab/NBT-bridge/blob/master/assets/zgw_front_panel.png?raw=true)

Communication with the front panel is established via the LIN bus. It works as polling status of key-pressed, or volume knob position changed. An additional command is needed to adjust dimming lights.

API for LIN bus uses serial connection on board, so for programming firmware, these pins have to be disconnected by jumpers.

## NBT Bridge Circuit diagram

![alt text](https://github.com/vchmykhun-collab/NBT-bridge/blob/master/assets/NBT_bridge_scheme.png?raw=true)


## Next steps, Ideas

* Gesture recognition using PAJ7620 sensor
* Rear camera integration
* Enhanced PDC integration. Require matching PDC and RPDC protocols
* Nightvision Camera integration, see reference project below

## References

* http://www.loopybunny.co.uk/CarPC/k_can.html
* https://github.com/pavelmalik/BMWCanBridge

